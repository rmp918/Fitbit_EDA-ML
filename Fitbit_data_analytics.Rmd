---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
```{r}
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
library(tidyr)
library(plotly)


```


```{r}
#activity <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/dailyActivity_merged.csv")
#calories <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/hourlyCalories_merged.csv")
#intensities <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/hourlyIntensities_merged.csv")
#sleep <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/sleepDay_merged.csv")
#weight <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/weightLogInfo_merged.csv")
#Importing the data
dailyActivity_merged <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/dailyActivity_merged.csv")
dailyCalories_merged <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/dailyCalories_merged.csv")
dailyIntensities_merged <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/dailyIntensities_merged.csv")
dailySteps_merged <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/dailySteps_merged.csv")
sleepDay_merged <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/sleepDay_merged.csv")
weightLogInfo_merged <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/weightLogInfo_merged.csv")
```


```{r}
merge_1 <- merge(dailyActivity_merged, dailyCalories_merged, by = c("Id","Calories"))
merge_2 <- merge(dailyIntensities_merged, dailyIntensities_merged, by = c("Id","ActivityDay","SedentaryMinutes", "LightlyActiveMinutes","FairlyActiveMinutes","VeryActiveMinutes", "SedentaryActiveDistance", "LightActiveDistance", "ModeratelyActiveDistance", "VeryActiveDistance"))

merge_daily <- merge(merge_1, merge_2, by = c("Id","ActivityDay","SedentaryMinutes", "LightlyActiveMinutes","FairlyActiveMinutes","VeryActiveMinutes", "SedentaryActiveDistance", "LightActiveDistance", "ModeratelyActiveDistance", "VeryActiveDistance")) %>%
select(-ActivityDay) %>% rename(Date = ActivityDate)

daily_data <- merge(merge_daily, sleepDay_merged, by = "Id",all=TRUE) %>% drop_na() %>% select(-SleepDay, -TrackerDistance)

options(repr.plot.width=30)
```


```{r}
head(daily_data)
summary(daily_data)

```

```{r}
daily_data1 <- daily_data %>%
summarise(
user_type = factor(case_when(
    SedentaryMinutes > mean(SedentaryMinutes) & LightlyActiveMinutes < mean(LightlyActiveMinutes) & FairlyActiveMinutes < mean(FairlyActiveMinutes) & VeryActiveMinutes < mean(VeryActiveMinutes) ~ "Sedentary",
    SedentaryMinutes < mean(SedentaryMinutes) & LightlyActiveMinutes > mean(LightlyActiveMinutes) & FairlyActiveMinutes < mean(FairlyActiveMinutes) & VeryActiveMinutes < mean(VeryActiveMinutes) ~ "Lightly Active",
    SedentaryMinutes < mean(SedentaryMinutes) & LightlyActiveMinutes < mean(LightlyActiveMinutes) & FairlyActiveMinutes > mean(FairlyActiveMinutes) & VeryActiveMinutes < mean(VeryActiveMinutes) ~ "Fairly Active",
    SedentaryMinutes < mean(SedentaryMinutes) & LightlyActiveMinutes < mean(LightlyActiveMinutes) & FairlyActiveMinutes < mean(FairlyActiveMinutes) & VeryActiveMinutes > mean(VeryActiveMinutes) ~ "Very Active",
    TRUE  ~ "other"
),levels=c("Sedentary", "Lightly Active", "Fairly Active", "Very Active","other")))
daily_data$usertype <- daily_data1$user_type
```




```{r}
qplot(usertype,TotalDistance,data = daily_data)

```

```{r}
qplot(TotalSteps,TotalDistance,data = daily_data, color = usertype)
```

```{r}
daily_data1 <- daily_data 
data_by_usertype <- daily_data1 %>%
summarise(
user_type = factor(case_when(
    SedentaryMinutes > mean(SedentaryMinutes) & LightlyActiveMinutes < mean(LightlyActiveMinutes) & FairlyActiveMinutes < mean(FairlyActiveMinutes) & VeryActiveMinutes < mean(VeryActiveMinutes) ~ "Sedentary",
    SedentaryMinutes < mean(SedentaryMinutes) & LightlyActiveMinutes > mean(LightlyActiveMinutes) & FairlyActiveMinutes < mean(FairlyActiveMinutes) & VeryActiveMinutes < mean(VeryActiveMinutes) ~ "Lightly Active",
    SedentaryMinutes < mean(SedentaryMinutes) & LightlyActiveMinutes < mean(LightlyActiveMinutes) & FairlyActiveMinutes > mean(FairlyActiveMinutes) & VeryActiveMinutes < mean(VeryActiveMinutes) ~ "Fairly Active",
    SedentaryMinutes < mean(SedentaryMinutes) & LightlyActiveMinutes < mean(LightlyActiveMinutes) & FairlyActiveMinutes < mean(FairlyActiveMinutes) & VeryActiveMinutes > mean(VeryActiveMinutes) ~ "Very Active",
),levels=c("Sedentary", "Lightly Active", "Fairly Active", "Very Active")), Id,SedentaryMinutes,LightlyActiveMinutes,FairlyActiveMinutes,VeryActiveMinutes,SedentaryActiveDistance,LightActiveDistance,ModeratelyActiveDistance,VeryActiveDistance,Calories,Date,TotalSteps,TotalDistance,LoggedActivitiesDistance,TotalSleepRecords,TotalMinutesAsleep ,TotalTimeInBed ) %>%
drop_na()

#daily_data1$usertype <- data_by_usertype$user_type




```


```{r}

t <- ggplot(data_by_usertype, aes(x = "",y = user_type,  fill = user_type)) +
  geom_bar(width = 1, stat = "identity") + coord_polar("y", start = 0)+ theme_void()
t
```




```{r}
qplot(TotalSteps,TotalDistance,data = data_by_usertype, color = user_type)

```


```{r}
#plotly作圖
p <- ggplot(data_by_usertype, aes(x = TotalDistance, y = TotalSteps)) +
  geom_point() +geom_smooth(aes(colour = user_type, fill = user_type),method='lm')+
  facet_wrap(~ user_type, ncol = 4)
ggplotly(p)



```


```{r}
qplot(TotalDistance,TotalTimeInBed,data = data_by_usertype, color = user_type)

```


```{r}
#plotly作圖
p <- ggplot(data_by_usertype, aes(x = TotalDistance, y = TotalTimeInBed)) +
  geom_point() +
  facet_wrap(~ user_type, ncol = 4)
ggplotly(p)
```


```{r}
qplot(TotalDistance,TotalMinutesAsleep,data = data_by_usertype, color = user_type)
```


```{r}
#plotly作圖
p <- ggplot(data_by_usertype, aes(x = TotalDistance, y = TotalMinutesAsleep)) +
  geom_point() +
  facet_wrap(~ user_type, ncol = 4)
ggplotly(p)
```


#```{r}
#write.csv(data_by_usertype, file = "C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/data_by_usertype.csv", fileEncoding = #"UTF-8")
#```


```{r}
test <- read.csv("C:/Users/alex/OneDrive/自主學習/R/archive/Fitabase Data 4.12.16-5.12.16/data_by_usertype.csv")
test$TotalSleepRecords <- as.factor(test$TotalSleepRecords)
test$user_type <- as.ordered(test$user_type)
```

```{r}
test1 <- test[-c(1:9)]
test1$TotalSleepRecords <- as.numeric(test1$TotalSleepRecords)

round(cor(test1),2)
```

```{r}
pairs(test1)
```


```{r}
library(MASS)
picktest <- polr( user_type ~ Calories+TotalSteps+TotalDistance+LoggedActivitiesDistance+TotalSleepRecords+TotalMinutesAsleep+TotalTimeInBed, data = test , Hess = T, method = 'logistic')
stepAIC(picktest)



```

```{r}
library(MASS)
picktest <- polr( user_type ~ Calories+TotalDistance+LoggedActivitiesDistance+TotalSleepRecords, data = test , Hess = T, method = 'logistic')
stepAIC(picktest)
```


```{r}
library(MASS)
picktest <- polr( user_type ~ Calories+TotalSteps+TotalDistance+LoggedActivitiesDistance+TotalSleepRecords+TotalMinutesAsleep, data = test , Hess = T, method = 'logistic')
stepAIC(picktest)

# 最後選擇Calories,TotalSteps,TotalDistance,LoggedActivitiesDistance,TotalSleepRecords這些變數作為後續模型的模型自變數
```

#Kmean algo.

```{r}
testcluster <- test[c(10:14)]

# KMeans 演算法
kmeans_fit <- kmeans(testcluster, nstart=20, centers=3)

# 印出分群結果
kmeans_fit$cluster


```

#Kmean Algo. Visualization about which K is better?

```{r}
# 迴圈 看分群觀察哪個點的ratio相對小
ratio <- rep(NA, times = 10)
for (k in 2:length(ratio)) {
  kmeans_fit <- kmeans(testcluster, centers = k, nstart = 20)
  ratio[k] <- kmeans_fit$tot.withinss / kmeans_fit$betweenss
}
plot(ratio, type="b", xlab="k")
```

#Hierarchical Clustering Algo.

```{r}
# 由於階層式分群是依據個體間的「距離」來計算彼此的相似度。
# 我們會先使用dist()函數，來計算所有資料個體間的「距離矩陣(Distance Matrix)」
# 而「距離」的算法又有：(1)歐式距離(2)曼哈頓距離
 
E.dist <- dist(x = testcluster, method = "euclidean")
M.dist <- dist(x = testcluster, method = "manhattan")
 


 
# 將以上資料間距離作為參數投入階層式分群函數：hclust()
# 使用歐式距離進行分群
h.E.cluster <- hclust(E.dist)
plot(h.E.cluster, xlab="euclidean")
```


```{r}
# 使用曼哈頓距離進行分群
h.M.cluster <- hclust(M.dist) 
plot(h.M.cluster, xlab="manhattan")
```

```{r}
plot(hclust(E.dist, method="single"),xlab = "最近聚合法:single-linkage")   # 最近法
```


```{r}
plot(hclust(E.dist, method="complete"), xlab = "最遠聚合法:complete-linkage")  # 最遠法
```


```{r}
plot(hclust(E.dist, method="average"), xlab = "平均聚合法: average-linkage")  # 平均法
```


```{r}
plot(hclust(E.dist, method="centroid"), xlab = "中心法: centroid-linkage") # 中心法
```


```{r}
plot(hclust(E.dist, method="ward.D2"), xlab = "華德法: Ward's Method")  # 華德法
```




```{r}
library(cluster)
# methods to assess
m <- c( "average", "single", "complete", "ward")
names(m) <- c( "average", "single", "complete", "ward")
 
# function to compute coefficient
ac <- function(x) {
  agnes(E.dist, method = x)$ac
}
 
map_dbl(m, ac) #Apply a function to each element of a vector 

```


```{r}
hc2 <- agnes(E.dist, method = "ward")
pltree(hc2, cex = 0.6, hang = -1, main = "Dendrogram of agnes")
```


```{r}
h.E.Ward.cluster <- hclust(E.dist, method="ward.D2")
plot(h.E.Ward.cluster)
rect.hclust(tree =h.E.Ward.cluster, k = 3, border = "red")
rect.hclust(tree =h.E.Ward.cluster, k = 13, border = "blue")
```


```{r}
h.E.Ward.cluster <- hclust(E.dist, method="ward.D2")
plot(h.E.Ward.cluster)
rect.hclust(tree =h.E.Ward.cluster, h = 4, border = "red")
rect.hclust(tree =h.E.Ward.cluster, h = 10, border = "blue")
```


```{r}
h.E.Ward.cluster <- hclust(E.dist, method="ward.D2")
cut.h.cluster <- cutree(tree = h.E.Ward.cluster, k = 4)
cut.h.cluster
```


```{r}
table(cut.h.cluster, test$user_type)
```


```{r}
# compute divisive hierarchical clustering
diana_clust <- diana(testcluster)
 
# Divise coefficient; amount of clustering structure found
diana_clust$dc
## [1] 0.8514345
 
# plot dendrogram
pltree(diana_clust, cex = 0.6, hang = -1, main = "Dendrogram of diana")
```


```{r}
# Cut diana() tree into 4 groups
diana_clust <- diana(testcluster)
group <- cutree(diana_clust, k = 4)
group
```

#Random Forest Algo.
```{r}
library(randomForest)
set.seed(123)
testrf = randomForest(testcluster)
testrf
```


```{r}
MDSplot(testrf,test$user_type,platte = rep(1,4),pch = as.numeric(test$user_type))
```


```{r}

```


```{r}
```
